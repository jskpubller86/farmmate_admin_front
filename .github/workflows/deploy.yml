name: Deploy to OCI Rocky Server

on:
    pull_request:
        types: [closed]
        branches: [main]
    push:
        branches: [test]
jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "yarn"

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build application
              run: yarn build:prod

            - name: Deploy to OCI Rocky Server
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.OCI_HOST }}
                  username: ${{ secrets.OCI_USERNAME }}
                  key: ${{ secrets.OCI_SSH_KEY }}
                  port: ${{ secrets.OCI_PORT }}
                  script: |
                      # 기존 배포 디렉토리 백업 (선택사항)
                      if [ -d "/var/www/farmmate_admin_front_backup" ]; then
                        sudo rm -rf /var/www/farmmate_admin_front_backup
                      fi
                      if [ -d "/var/www/farmmate_admin_front" ]; then
                        sudo mv /var/www/farmmate_admin_front /var/www/farmmate_admin_front_backup
                      fi

                      # 새로운 배포 디렉토리 생성
                      mkdir -p /var/www/farmmate_admin_front

            - name: Upload build files
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.OCI_HOST }}
                  username: ${{ secrets.OCI_USERNAME }}
                  key: ${{ secrets.OCI_SSH_KEY }}
                  port: ${{ secrets.OCI_PORT }}
                  source: "build/*"
                  target: "/var/www/farmmate_admin_front"
                  strip_components: 1

            - name: Set permissions and ownership
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.OCI_HOST }}
                  username: ${{ secrets.OCI_USERNAME }}
                  key: ${{ secrets.OCI_SSH_KEY }}
                  port: ${{ secrets.OCI_PORT }}
                  script: |
                      # 권한 설정
                      sudo chmod -R 755 /var/www/farmmate_admin_front

                      # 소유권 설정
                      sudo chown -R nginx:nginx /var/www/farmmate_admin_front

                      # nginx 설정 테스트 및 재시작
                      sudo nginx -t && sudo systemctl reload nginx

                      # 배포 완료 로그
                      echo "Deployment completed successfully at $(date)"
                      echo "Deployed to: /var/www/farmmate_admin_front"
